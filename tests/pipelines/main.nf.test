nextflow_pipeline {
    name "Integration Tests for Arborator pipeline"
    script "main.nf"

    test("Small-scale test of full pipeline"){
        tag "pipeline"
        when {
            params {
                input = "$baseDir/tests/data/samplesheets/samplesheet.csv"
                outdir = "results"

                metadata_partition_name = "outbreak"
                metadata_1_header = "organism"
                metadata_2_header = "subtype"
                metadata_3_header = "country"
                metadata_4_header = "serovar"
                metadata_5_header = "age"
                metadata_6_header = "date"
                metadata_7_header = "source"
                metadata_8_header = "special"
            }
        }

        then {
            assert workflow.success
            assert path("$launchDir/results").exists()

            // Check merged profiles
            def actual_profile_tsv = path("$launchDir/results/merged/profile.tsv")
            def expected_profile_tsv = path("$baseDir/tests/data/profiles/merged_profiles.tsv")
            assert actual_profile_tsv.text == expected_profile_tsv.text

            // Check aggregated metadata
            def actual_metadata = path("$launchDir/results/metadata/aggregated_data.tsv")
            def expected_metadata = path("$baseDir/tests/data/metadata/expected_merged_data.tsv")
            assert actual_metadata.text == expected_metadata.text

            // Check auto-built config file:
            def actual_config = path("$launchDir/results/build/config.json")
            def expected_config = path("$baseDir/tests/data/configs/autoconfig_samplesheet.json")
            assert actual_config.text == expected_config.text

            // Arborator outputs:
            // NOTE: Arborator produces a (somewhat) non-deterministic cluster summary,
            // so it's not possible to compare the entire output.
            def actual_arborator_summary = path("$launchDir/results/arborator/cluster_summary.tsv")
            assert actual_arborator_summary.text.contains("Outbreak Code\tOrganism\tSubtype\tCountry of Collection\tSerovar\tPatient Age (years)\tDate\tSource Type\tSpecial")
            assert actual_arborator_summary.text.contains("1\tEscherichia coli\tEHEC/STEC\tCanada,The United States\tO157:H7\t21,55\t2024/05/21,2024/05/30\tbeef,milk\tFalse,True")

            def actual_arborator_meta_included = path("$launchDir/results/arborator/metadata.included.tsv")
            def expected_arborator_meta_included = path("$baseDir/tests/data/arborator/basic/metadata.included.tsv")
            assert actual_arborator_meta_included.text == expected_arborator_meta_included.text

            def actual_arborator_tree_1 = path("$launchDir/results/arborator/1_tree.nwk")
            def expected_arborator_tree_1 = path("$baseDir/tests/data/arborator/1/tree.nwk")
            assert actual_arborator_tree_1.text == expected_arborator_tree_1.text

            def actual_arborator_tree_2 = path("$launchDir/results/arborator/2_tree.nwk")
            def expected_arborator_tree_2 = path("$baseDir/tests/data/arborator/2/tree.nwk")
            assert actual_arborator_tree_2.text == expected_arborator_tree_2.text

            assert path("$launchDir/results/arborator/1_clusters.tsv").exists()
            assert path("$launchDir/results/arborator/1_loci.summary.tsv").exists()
            assert path("$launchDir/results/arborator/1_matrix.pq").exists()
            assert path("$launchDir/results/arborator/1_matrix.tsv").exists()
            assert path("$launchDir/results/arborator/1_metadata.tsv").exists()
            assert path("$launchDir/results/arborator/1_outliers.tsv").exists()
            assert path("$launchDir/results/arborator/1_profile.tsv").exists()
            assert path("$launchDir/results/arborator/1_tree.nwk").exists()

            assert path("$launchDir/results/arborator/2_clusters.tsv").exists()
            assert path("$launchDir/results/arborator/2_loci.summary.tsv").exists()
            assert path("$launchDir/results/arborator/2_matrix.pq").exists()
            assert path("$launchDir/results/arborator/2_matrix.tsv").exists()
            assert path("$launchDir/results/arborator/2_metadata.tsv").exists()
            assert path("$launchDir/results/arborator/2_outliers.tsv").exists()
            assert path("$launchDir/results/arborator/2_profile.tsv").exists()
            assert path("$launchDir/results/arborator/2_tree.nwk").exists()

            // Check that the ArborView output is created
            def actual_arborview1 = path("$launchDir/results/arborview/1_arborview.html")
            assert actual_arborview1.exists()
            assert actual_arborview1.text.contains("sample_name\\tsample\\toutbreak\\torganism\\tsubtype\\tcountry\\tserovar\\tage\\tdate\\tsource\\tspecial\\nS1\\tS1\\t1\\tEscherichia coli\\tEHEC/STEC\\tCanada\\tO157:H7\\t21\\t2024/05/30\\tbeef\\tTrue\\nS2\\tS2\\t1\\tEscherichia coli\\tEHEC/STEC\\tThe United States\\tO157:H7\\t55\\t2024/05/21\\tmilk\\tFalse\\n")

            def actual_arborview2 = path("$launchDir/results/arborview/2_arborview.html")
            assert actual_arborview2.exists()
            assert actual_arborview2.text.contains("sample_name\\tsample\\toutbreak\\torganism\\tsubtype\\tcountry\\tserovar\\tage\\tdate\\tsource\\tspecial\\nS3\\tS3\\t2\\tEscherichia coli\\tEPEC\\tFrance\\tO125\\t14\\t2024/04/30\\tcheese\\tTrue\\nS4\\tS4\\t2\\tEscherichia coli\\tEPEC\\tFrance\\tO125\\t35\\t2024/04/22\\tcheese\\tTrue\\n")

            // compare IRIDA Next JSON output
            def iridanext_json = path("$launchDir/results/iridanext.output.json").json
            def iridanext_global = iridanext_json.files.global
            def iridanext_samples = iridanext_json.files.samples
            def iridanext_metadata = iridanext_json.metadata.samples

            assert iridanext_global.findAll { it.path == "arborator/1_clusters.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_loci.summary.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_matrix.pq" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_matrix.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_metadata.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_outliers.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_profile.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_tree.nwk" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_clusters.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_loci.summary.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_matrix.pq" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_matrix.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_metadata.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_outliers.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_profile.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_tree.nwk" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/cluster_summary.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/metadata.excluded.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/metadata.included.tsv" }.size() == 1

            assert iridanext_samples.isEmpty()
            assert iridanext_metadata.isEmpty()
        }
    }

    test("Small-scale test of full pipeline with all samples same partition"){
        tag "pipeline_all"
        when {
            params {
                input = "$baseDir/tests/data/samplesheets/samplesheet-all-single-partition.csv"
                outdir = "results"

                metadata_partition_name = "outbreak"
                metadata_1_header = "organism"
                metadata_2_header = "subtype"
                metadata_3_header = "country"
                metadata_4_header = "serovar"
                metadata_5_header = "age"
                metadata_6_header = "date"
                metadata_7_header = "source"
                metadata_8_header = "special"
            }
        }

        then {
            assert workflow.success
            assert path("$launchDir/results").exists()

            // Check merged profiles
            def actual_profile_tsv = path("$launchDir/results/merged/profile.tsv")
            def expected_profile_tsv = path("$baseDir/tests/data/profiles/merged_profiles.tsv")
            assert actual_profile_tsv.text == expected_profile_tsv.text

            // Check aggregated metadata
            def actual_metadata = path("$launchDir/results/metadata/aggregated_data.tsv")
            def expected_metadata = path("$baseDir/tests/data/metadata/expected_merged_data.tsv")
            //assert actual_metadata.text == expected_metadata.text

            // Arborator outputs:
            // NOTE: Arborator produces a (somewhat) non-deterministic cluster summary,
            // so it's not possible to compare the entire output.
            def actual_arborator_summary = path("$launchDir/results/arborator/cluster_summary.tsv")
            //assert actual_arborator_summary.text.contains("Outbreak Code\tOrganism\tSubtype\tCountry of Collection\tSerovar\tPatient Age (years)\tDate\tSource Type\tSpecial")
            //assert actual_arborator_summary.text.contains("1\tEscherichia coli\tEHEC/STEC\tCanada,The United States\tO157:H7\t21,55\t2024/05/21,2024/05/30\tbeef,milk\tFalse,True")

            def actual_arborator_meta_included = path("$launchDir/results/arborator/metadata.included.tsv")
            def expected_arborator_meta_included = path("$baseDir/tests/data/arborator/basic/metadata.included.tsv")
            //assert actual_arborator_meta_included.text == expected_arborator_meta_included.text

            def actual_arborator_tree_1 = path("$launchDir/results/arborator/1_tree.nwk")
            def expected_arborator_tree_1 = path("$baseDir/tests/data/arborator/1/tree_all_single_partition.nwk")
            assert actual_arborator_tree_1.text == expected_arborator_tree_1.text

            assert path("$launchDir/results/arborator/1_clusters.tsv").exists()
            assert path("$launchDir/results/arborator/1_loci.summary.tsv").exists()
            assert path("$launchDir/results/arborator/1_matrix.pq").exists()
            assert path("$launchDir/results/arborator/1_matrix.tsv").exists()
            assert path("$launchDir/results/arborator/1_metadata.tsv").exists()
            assert path("$launchDir/results/arborator/1_outliers.tsv").exists()
            assert path("$launchDir/results/arborator/1_profile.tsv").exists()
            assert path("$launchDir/results/arborator/1_tree.nwk").exists()

            // Since all samples in same partition, 1, should be no output files prefixed with 2
            assert !path("$launchDir/results/arborator/2_clusters.tsv").exists()
            assert !path("$launchDir/results/arborator/2_loci.summary.tsv").exists()
            assert !path("$launchDir/results/arborator/2_matrix.pq").exists()
            assert !path("$launchDir/results/arborator/2_matrix.tsv").exists()
            assert !path("$launchDir/results/arborator/2_metadata.tsv").exists()
            assert !path("$launchDir/results/arborator/2_outliers.tsv").exists()
            assert !path("$launchDir/results/arborator/2_profile.tsv").exists()
            assert !path("$launchDir/results/arborator/2_tree.nwk").exists()

            // Check that the ArborView output is created
            def actual_arborview1 = path("$launchDir/results/arborview/1_arborview.html")
            //assert actual_arborview1.exists()
            //assert actual_arborview1.text.contains("sample_name\\tsample\\toutbreak\\torganism\\tsubtype\\tcountry\\tserovar\\tage\\tdate\\tsource\\tspecial\\nS1\\tS1\\t1\\tEscherichia coli\\tEHEC/STEC\\tCanada\\tO157:H7\\t21\\t2024/05/30\\tbeef\\tTrue\\nS2\\tS2\\t1\\tEscherichia coli\\tEHEC/STEC\\tThe United States\\tO157:H7\\t55\\t2024/05/21\\tmilk\\tFalse\\n")

            // compare IRIDA Next JSON output
            def iridanext_json = path("$launchDir/results/iridanext.output.json").json
            def iridanext_global = iridanext_json.files.global
            def iridanext_samples = iridanext_json.files.samples
            def iridanext_metadata = iridanext_json.metadata.samples

            assert iridanext_global.findAll { it.path == "arborator/1_clusters.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_loci.summary.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_matrix.pq" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_matrix.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_metadata.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_outliers.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_profile.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_tree.nwk" }.size() == 1

            // Since all samples in same partition, 1, should be no output files prefixed with 2
            assert iridanext_global.findAll { it.path == "arborator/2_clusters.tsv" }.size() == 0
            assert iridanext_global.findAll { it.path == "arborator/2_loci.summary.tsv" }.size() == 0
            assert iridanext_global.findAll { it.path == "arborator/2_matrix.pq" }.size() == 0
            assert iridanext_global.findAll { it.path == "arborator/2_matrix.tsv" }.size() == 0
            assert iridanext_global.findAll { it.path == "arborator/2_metadata.tsv" }.size() == 0
            assert iridanext_global.findAll { it.path == "arborator/2_outliers.tsv" }.size() == 0
            assert iridanext_global.findAll { it.path == "arborator/2_profile.tsv" }.size() == 0
            assert iridanext_global.findAll { it.path == "arborator/2_tree.nwk" }.size() == 0

            assert iridanext_global.findAll { it.path == "arborator/cluster_summary.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/metadata.excluded.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/metadata.included.tsv" }.size() == 1

            assert iridanext_samples.isEmpty()
            assert iridanext_metadata.isEmpty()
        }
    }

    test("Small-scale test of full pipeline, missing metadata"){
        tag "pipeline"
        when {
            params {
                input = "$baseDir/tests/data/samplesheets/samplesheet-little-metadata.csv"
                outdir = "results"

                metadata_partition_name = "outbreak"
                metadata_1_header = "organism"
                metadata_2_header = "subtype"
                metadata_3_header = "country"
                metadata_4_header = "serovar"
                metadata_5_header = "age"
                metadata_6_header = "date"
                metadata_7_header = "source"
                metadata_8_header = "special"
            }
        }

        then {
            assert workflow.success
            assert path("$launchDir/results").exists()

            // Check merged profiles
            def actual_profile_tsv = path("$launchDir/results/merged/profile.tsv")
            def expected_profile_tsv = path("$baseDir/tests/data/profiles/merged_profiles.tsv")
            assert actual_profile_tsv.text == expected_profile_tsv.text

            // Check aggregated metadata
            def actual_metadata = path("$launchDir/results/metadata/aggregated_data.tsv")
            def expected_metadata = path("$baseDir/tests/data/metadata/little-metadata-merged.tsv")
            assert actual_metadata.text == expected_metadata.text

            // Check auto-built config file:
            def actual_config = path("$launchDir/results/build/config.json")
            def expected_config = path("$baseDir/tests/data/configs/autoconfig_little-metadata.json")
            assert actual_config.text == expected_config.text

            // Arborator outputs:
            // NOTE: Arborator produces a (somewhat) non-deterministic cluster summary,
            // so it's not possible to compare the entire output.
            def actual_arborator_summary = path("$launchDir/results/arborator/cluster_summary.tsv")
            assert actual_arborator_summary.text.contains("Outbreak Code\tOrganism\tSubtype")
            assert actual_arborator_summary.text.contains("1\tEscherichia coli\tEHEC/STEC")

            def actual_arborator_meta_included = path("$launchDir/results/arborator/metadata.included.tsv")
            def expected_arborator_meta_included = path("$baseDir/tests/data/arborator/little_metadata/metadata.included.tsv")
            assert actual_arborator_meta_included.text == expected_arborator_meta_included.text

            assert path("$launchDir/results/arborator/1_clusters.tsv").exists()
            assert path("$launchDir/results/arborator/1_loci.summary.tsv").exists()
            assert path("$launchDir/results/arborator/1_matrix.pq").exists()
            assert path("$launchDir/results/arborator/1_matrix.tsv").exists()
            assert path("$launchDir/results/arborator/1_metadata.tsv").exists()
            assert path("$launchDir/results/arborator/1_outliers.tsv").exists()
            assert path("$launchDir/results/arborator/1_profile.tsv").exists()
            assert path("$launchDir/results/arborator/1_tree.nwk").exists()

            assert path("$launchDir/results/arborator/2_clusters.tsv").exists()
            assert path("$launchDir/results/arborator/2_loci.summary.tsv").exists()
            assert path("$launchDir/results/arborator/2_matrix.pq").exists()
            assert path("$launchDir/results/arborator/2_matrix.tsv").exists()
            assert path("$launchDir/results/arborator/2_metadata.tsv").exists()
            assert path("$launchDir/results/arborator/2_outliers.tsv").exists()
            assert path("$launchDir/results/arborator/2_profile.tsv").exists()
            assert path("$launchDir/results/arborator/2_tree.nwk").exists()

            // Check that the ArborView output is created
            def actual_arborview1 = path("$launchDir/results/arborview/1_arborview.html")
            assert actual_arborview1.exists()
            assert actual_arborview1.text.contains("sample_name\\tsample\\toutbreak\\torganism\\tsubtype\\nS1\\tS1\\t1\\tEscherichia coli\\tEHEC/STEC\\nS2\\tS2\\t1\\tEscherichia coli\\tEHEC/STEC\\n")

            def actual_arborview2 = path("$launchDir/results/arborview/2_arborview.html")
            assert actual_arborview2.exists()
            assert actual_arborview2.text.contains("sample_name\\tsample\\toutbreak\\torganism\\tsubtype\\nS3\\tS3\\t2\\tEscherichia coli\\tEPEC\\nS4\\tS4\\t2\\tEscherichia coli\\tEPEC\\n")

            // compare IRIDA Next JSON output
            def iridanext_json = path("$launchDir/results/iridanext.output.json").json
            def iridanext_global = iridanext_json.files.global
            def iridanext_samples = iridanext_json.files.samples
            def iridanext_metadata = iridanext_json.metadata.samples

            assert iridanext_global.findAll { it.path == "arborator/1_clusters.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_loci.summary.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_matrix.pq" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_matrix.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_metadata.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_outliers.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_profile.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_tree.nwk" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_clusters.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_loci.summary.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_matrix.pq" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_matrix.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_metadata.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_outliers.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_profile.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_tree.nwk" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/cluster_summary.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/metadata.excluded.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/metadata.included.tsv" }.size() == 1

            assert iridanext_samples.isEmpty()
            assert iridanext_metadata.isEmpty()
        }
    }

    test("bad metadata_partition_name"){
        tag "bad_metadata_partition_name"
        when {
            params {
                input = "$baseDir/tests/data/samplesheets/samplesheet.csv"
                outdir = "results"

                metadata_partition_name = "bad;>"
                metadata_1_header = "organism"
                metadata_2_header = "subtype"
                metadata_3_header = "country"
                metadata_4_header = "serovar"
                metadata_5_header = "age"
                metadata_6_header = "date"
                metadata_7_header = "source"
                metadata_8_header = "special"
            }
        }

        then {
            assert workflow.failed
            assert workflow.stderr.join("\n").contains("string [bad;>] does not match pattern")
        }
    }

    test("bad metadata_1_header"){
        tag "bad_metadata_1_header"
        when {
            params {
                input = "$baseDir/tests/data/samplesheets/samplesheet.csv"
                outdir = "results"

                metadata_partition_name = "outbreak"
                metadata_1_header = "organism|"
                metadata_2_header = "subtype"
                metadata_3_header = "country"
                metadata_4_header = "serovar"
                metadata_5_header = "age"
                metadata_6_header = "date"
                metadata_7_header = "source"
                metadata_8_header = "special"
            }
        }

        then {
            assert workflow.failed
            assert workflow.stderr.join("\n").contains("string [organism|] does not match pattern")
        }
    }

    test("bad metadata_8_header"){
        tag "bad_metadata_8_header"
        when {
            params {
                input = "$baseDir/tests/data/samplesheets/samplesheet.csv"
                outdir = "results"

                metadata_partition_name = "outbreak"
                metadata_1_header = "organism"
                metadata_2_header = "subtype"
                metadata_3_header = "country"
                metadata_4_header = "serovar"
                metadata_5_header = "age"
                metadata_6_header = "date"
                metadata_7_header = "source"
                metadata_8_header = "spe>cial"
            }
        }

        then {
            assert workflow.failed
            assert workflow.stderr.join("\n").contains("string [spe>cial] does not match pattern")
        }
    }

    test("bad meta_partition entry"){
        tag "bad_meta_partition_entry"
        when {
            params {
                input = "$baseDir/tests/data/samplesheets/samplesheet-bad-metadata_partition.csv"
                outdir = "results"

                metadata_partition_name = "outbreak"
                metadata_1_header = "organism"
                metadata_2_header = "subtype"
                metadata_3_header = "country"
                metadata_4_header = "serovar"
                metadata_5_header = "age"
                metadata_6_header = "date"
                metadata_7_header = "source"
                metadata_8_header = "special"
            }
        }

        then {
            assert workflow.failed
            assert workflow.stderr.join("\n").contains("Metadata column used to partition clusters. Must contain only alphanumeric, underscore, period, and dash characters. (1@)")
        }
    }

    test("bad metadata_partition entry"){
        tag "bad_metadata_partition_entry"
        when {
            params {
                input = "$baseDir/tests/data/samplesheets/samplesheet-bad-metadata_partition.csv"
                outdir = "results"

                metadata_partition_name = "outbreak"
                metadata_1_header = "organism"
                metadata_2_header = "subtype"
                metadata_3_header = "country"
                metadata_4_header = "serovar"
                metadata_5_header = "age"
                metadata_6_header = "date"
                metadata_7_header = "source"
                metadata_8_header = "special"
            }
        }

        then {
            assert workflow.failed
            assert workflow.stderr.join("\n").contains("metadata_partition: Metadata column used to partition clusters. Must contain only alphanumeric, underscore, period, and dash characters. (1@)")
        }
    }

    test("bad metadata_1 entry"){
        tag "bad_metadata_1_entry"
        when {
            params {
                input = "$baseDir/tests/data/samplesheets/samplesheet-bad-metadata_1.csv"
                outdir = "results"

                metadata_partition_name = "outbreak"
                metadata_1_header = "organism"
                metadata_2_header = "subtype"
                metadata_3_header = "country"
                metadata_4_header = "serovar"
                metadata_5_header = "age"
                metadata_6_header = "date"
                metadata_7_header = "source"
                metadata_8_header = "special"
            }
        }

        then {
            assert workflow.failed
            assert workflow.stderr.join("\n").contains("metadata_1: Metadata associated with the sample (metadata_1). Cannot contain newlines, tabs, quotes, apostrophes, or any of the following characters: |;>< (Escherichia coli|)")
        }
    }

    test("Small-scale test of full pipeline, ID mismatch"){
        tag "id-mismatch"

        when {
            params {
                input = "$baseDir/tests/data/samplesheets/samplesheet-id-mismatch.csv"
                outdir = "results"

                metadata_partition_name = "outbreak"
                metadata_1_header = "organism"
                metadata_2_header = "subtype"
                metadata_3_header = "country"
                metadata_4_header = "serovar"
                metadata_5_header = "age"
                metadata_6_header = "date"
                metadata_7_header = "source"
                metadata_8_header = "special"
            }
        }

        then {
            assert workflow.success
            assert path("$launchDir/results").exists()

            // Check merged profiles
            def actual_profile_tsv = path("$launchDir/results/merged/profile.tsv")
            def expected_profile_tsv = path("$baseDir/tests/data/profiles/mismatched_profiles.tsv")
            assert actual_profile_tsv.text == expected_profile_tsv.text

            // Check aggregated metadata
            def actual_metadata = path("$launchDir/results/metadata/aggregated_data.tsv")
            def expected_metadata = path("$baseDir/tests/data/metadata/mismatched-metadata.tsv")
            assert actual_metadata.text == expected_metadata.text

            // Check auto-built config file:
            def actual_config = path("$launchDir/results/build/config.json")
            def expected_config = path("$baseDir/tests/data/configs/autoconfig_samplesheet.json")
            assert actual_config.text == expected_config.text

            // Arborator outputs:
            // NOTE: Arborator produces a (somewhat) non-deterministic cluster summary,
            // so it's not possible to compare the entire output.
            def actual_arborator_summary = path("$launchDir/results/arborator/cluster_summary.tsv")
            assert actual_arborator_summary.text.contains("Outbreak Code\tOrganism\tSubtype\tCountry of Collection\tSerovar\tPatient Age (years)\tDate\tSource Type\tSpecial")
            assert actual_arborator_summary.text.contains("1\tEscherichia coli\tEHEC/STEC\tCanada,The United States\tO157:H7\t21,55\t2024/05/21,2024/05/30\tbeef,milk\tFalse,True")

            def actual_arborator_meta_included = path("$launchDir/results/arborator/metadata.included.tsv")
            def expected_arborator_meta_included = path("$baseDir/tests/data/arborator/mismatch/metadata.included.tsv")
            assert actual_arborator_meta_included.text == expected_arborator_meta_included.text

            assert path("$launchDir/results/arborator/1_clusters.tsv").exists()
            assert path("$launchDir/results/arborator/1_loci.summary.tsv").exists()
            assert path("$launchDir/results/arborator/1_matrix.pq").exists()
            assert path("$launchDir/results/arborator/1_matrix.tsv").exists()
            assert path("$launchDir/results/arborator/1_metadata.tsv").exists()
            assert path("$launchDir/results/arborator/1_outliers.tsv").exists()
            assert path("$launchDir/results/arborator/1_profile.tsv").exists()
            assert path("$launchDir/results/arborator/1_tree.nwk").exists()

            assert path("$launchDir/results/arborator/2_clusters.tsv").exists()
            assert path("$launchDir/results/arborator/2_loci.summary.tsv").exists()
            assert path("$launchDir/results/arborator/2_matrix.pq").exists()
            assert path("$launchDir/results/arborator/2_matrix.tsv").exists()
            assert path("$launchDir/results/arborator/2_metadata.tsv").exists()
            assert path("$launchDir/results/arborator/2_outliers.tsv").exists()
            assert path("$launchDir/results/arborator/2_profile.tsv").exists()
            assert path("$launchDir/results/arborator/2_tree.nwk").exists()

            // Check that the ArborView output is created
            def actual_arborview1 = path("$launchDir/results/arborview/1_arborview.html")
            assert actual_arborview1.exists()
            assert actual_arborview1.text.contains("sample_name\\tsample\\toutbreak\\torganism\\tsubtype\\tcountry\\tserovar\\tage\\tdate\\tsource\\tspecial\\nS1\\tS1\\t1\\tEscherichia coli\\tEHEC/STEC\\tCanada\\tO157:H7\\t21\\t2024/05/30\\tbeef\\tTrue\\nMISMATCH\\tMISMATCH\\t1\\tEscherichia coli\\tEHEC/STEC\\tThe United States\\tO157:H7\\t55\\t2024/05/21\\tmilk\\tFalse\\n")

            def actual_arborview2 = path("$launchDir/results/arborview/2_arborview.html")
            assert actual_arborview2.exists()
            assert actual_arborview2.text.contains("sample_name\\tsample\\toutbreak\\torganism\\tsubtype\\tcountry\\tserovar\\tage\\tdate\\tsource\\tspecial\\nS3\\tS3\\t2\\tEscherichia coli\\tEPEC\\tFrance\\tO125\\t14\\t2024/04/30\\tcheese\\tTrue\\nS4\\tS4\\t2\\tEscherichia coli\\tEPEC\\tFrance\\tO125\\t35\\t2024/04/22\\tcheese\\tTrue\\n")

            // compare IRIDA Next JSON output
            def iridanext_json = path("$launchDir/results/iridanext.output.json").json
            def iridanext_global = iridanext_json.files.global
            def iridanext_samples = iridanext_json.files.samples
            def iridanext_metadata = iridanext_json.metadata.samples

            assert iridanext_global.findAll { it.path == "arborator/1_clusters.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_loci.summary.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_matrix.pq" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_matrix.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_metadata.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_outliers.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_profile.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_tree.nwk" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_clusters.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_loci.summary.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_matrix.pq" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_matrix.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_metadata.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_outliers.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_profile.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_tree.nwk" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/cluster_summary.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/metadata.excluded.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/metadata.included.tsv" }.size() == 1

            assert iridanext_samples.isEmpty()
            assert iridanext_metadata.isEmpty()
        }
    }

    test("Small-scale test of full pipeline, sample_name column added"){
        tag "sample_name"
        when {
            params {
                input = "$baseDir/tests/data/samplesheets/samplesheet-samplename.csv"
                outdir = "results"

                metadata_partition_name = "outbreak"
                metadata_1_header = "organism"
                metadata_2_header = "subtype"
                metadata_3_header = "country"
                metadata_4_header = "serovar"
                metadata_5_header = "age"
                metadata_6_header = "date"
                metadata_7_header = "source"
                metadata_8_header = "special"
            }
        }

        then {
            assert workflow.success
            assert path("$launchDir/results").exists()

            // Check merged profiles
            def actual_profile_tsv = path("$launchDir/results/merged/profile.tsv")
            def expected_profile_tsv = path("$baseDir/tests/data/profiles/samplenames_profiles.tsv")
            assert actual_profile_tsv.text == expected_profile_tsv.text

            // Check aggregated metadata
            def actual_metadata = path("$launchDir/results/metadata/aggregated_data.tsv")
            def expected_metadata = path("$baseDir/tests/data/metadata/samplenames-merged.tsv")
            assert actual_metadata.text == expected_metadata.text

            // Check auto-built config file:
            def actual_config = path("$launchDir/results/build/config.json")
            def expected_config = path("$baseDir/tests/data/configs/autoconfig_samplesheet.json")
            assert actual_config.text == expected_config.text

            // Arborator outputs:
            // NOTE: Arborator produces a (somewhat) non-deterministic cluster summary,
            // so it's not possible to compare the entire output.
            def actual_arborator_summary = path("$launchDir/results/arborator/cluster_summary.tsv")
            assert actual_arborator_summary.text.contains("Outbreak Code\tOrganism\tSubtype")
            assert actual_arborator_summary.text.contains("1\tEscherichia coli\tEHEC/STEC")

            def actual_arborator_meta_included = path("$launchDir/results/arborator/metadata.included.tsv")
            def expected_arborator_meta_included = path("$baseDir/tests/data/arborator/samplenames_metadata/metadata.included.tsv")
            assert actual_arborator_meta_included.text == expected_arborator_meta_included.text

            assert path("$launchDir/results/arborator/1_clusters.tsv").exists()
            assert path("$launchDir/results/arborator/1_loci.summary.tsv").exists()
            assert path("$launchDir/results/arborator/1_matrix.pq").exists()
            assert path("$launchDir/results/arborator/1_matrix.tsv").exists()
            assert path("$launchDir/results/arborator/1_metadata.tsv").exists()
            assert path("$launchDir/results/arborator/1_outliers.tsv").exists()
            assert path("$launchDir/results/arborator/1_profile.tsv").exists()
            assert path("$launchDir/results/arborator/1_tree.nwk").exists()

            assert path("$launchDir/results/arborator/2_clusters.tsv").exists()
            assert path("$launchDir/results/arborator/2_loci.summary.tsv").exists()
            assert path("$launchDir/results/arborator/2_matrix.pq").exists()
            assert path("$launchDir/results/arborator/2_matrix.tsv").exists()
            assert path("$launchDir/results/arborator/2_metadata.tsv").exists()
            assert path("$launchDir/results/arborator/2_outliers.tsv").exists()
            assert path("$launchDir/results/arborator/2_profile.tsv").exists()
            assert path("$launchDir/results/arborator/2_tree.nwk").exists()

            // Check that the ArborView output is created
            def actual_arborview1 = path("$launchDir/results/arborview/1_arborview.html")
            assert actual_arborview1.exists()
            assert actual_arborview1.text.contains("sample_name\\tsample\\toutbreak\\torganism\\tsubtype\\tcountry\\tserovar\\tage\\tdate\\tsource\\tspecial\\nsample1\\tS1\\t1\\tEscherichia coli\\tEHEC/STEC\\tCanada\\tO157:H7\\t21\\t2024/05/30\\tbeef\\tTrue\\nsample_2\\tS2\\t1\\tEscherichia coli\\tEHEC/STEC\\tThe United States\\tO157:H7\\t55\\t2024/05/21\\tmilk\\tFalse\\n")

            def actual_arborview2 = path("$launchDir/results/arborview/2_arborview.html")
            assert actual_arborview2.exists()
            assert actual_arborview2.text.contains("sample_name\\tsample\\toutbreak\\torganism\\tsubtype\\tcountry\\tserovar\\tage\\tdate\\tsource\\tspecial\\nsample_3\\tS3\\t2\\tEscherichia coli\\tEPEC\\tFrance\\tO125\\t14\\t2024/04/30\\tcheese\\tTrue\\nsample4\\tS4\\t2\\tEscherichia coli\\tEPEC\\tFrance\\tO125\\t35\\t2024/04/22\\tcheese\\tTrue\\n")

            // compare IRIDA Next JSON output
            def iridanext_json = path("$launchDir/results/iridanext.output.json").json
            def iridanext_global = iridanext_json.files.global
            def iridanext_samples = iridanext_json.files.samples
            def iridanext_metadata = iridanext_json.metadata.samples

            assert iridanext_global.findAll { it.path == "arborator/1_clusters.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_loci.summary.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_matrix.pq" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_matrix.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_metadata.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_outliers.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_profile.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/1_tree.nwk" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_clusters.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_loci.summary.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_matrix.pq" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_matrix.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_metadata.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_outliers.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_profile.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/2_tree.nwk" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/cluster_summary.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/metadata.excluded.tsv" }.size() == 1
            assert iridanext_global.findAll { it.path == "arborator/metadata.included.tsv" }.size() == 1

            assert iridanext_samples.isEmpty()
            assert iridanext_metadata.isEmpty()
        }
    }
}
